



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-0.17.2, mkdocs-material-2.6.3">
    
    
      
        <title>Snapshots - BitStream</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.9b572555.css">
      
    
    
      <script src="../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <a href="#snapshots" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="BitStream" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                BitStream
              </span>
              <span class="md-header-nav__topic">
                Snapshots
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/boisgera/bitstream/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      bitstream
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    <span class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </span>
    BitStream
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/boisgera/bitstream/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      bitstream
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../examples/" title="Examples" class="md-nav__link">
      Examples
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../installation/" title="Installation" class="md-nav__link">
      Installation
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../types/" title="Built-in Types" class="md-nav__link">
      Built-in Types
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../custom/" title="Custom Types" class="md-nav__link">
      Custom Types
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        Snapshots
      </label>
    
    <a href="./" title="Snapshots" class="md-nav__link md-nav__link--active">
      Snapshots
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#lookahead" title="Lookahead" class="md-nav__link">
    Lookahead
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exception-safety" title="Exception Safety" class="md-nav__link">
    Exception Safety
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#multiple-snapshots" title="Multiple Snapshots" class="md-nav__link">
    Multiple Snapshots
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-does-it-work" title="How does it Work?" class="md-nav__link">
    How does it Work?
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../API/" title="API Reference" class="md-nav__link">
      API Reference
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../contributing/" title="Contributing" class="md-nav__link">
      Contributing
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#lookahead" title="Lookahead" class="md-nav__link">
    Lookahead
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exception-safety" title="Exception Safety" class="md-nav__link">
    Exception Safety
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#multiple-snapshots" title="Multiple Snapshots" class="md-nav__link">
    Multiple Snapshots
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-does-it-work" title="How does it Work?" class="md-nav__link">
    How does it Work?
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/boisgera/bitstream/edit/master/mkdocs/snapshots.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="snapshots">Snapshots<a class="headerlink" href="#snapshots" title="Permanent link">&para;</a></h1>
<p>A stream is a simple model to deal with binary data,
but sometimes you need more: you want to perform some lookahead without 
changing the stream or you want to try some read/write operations 
but go back to the initial state if they fail. 
At this stage, you probably have copies of streams 
everywhere and the stream interface seems very cumbersome.</p>
<p>Therefore, we provide snapshots, a simple solution for these
use cases that doesn't require copies of streams:
you can save the state of a stream at any 
stage in a sequence of read/write operations and restore 
any such state later if you need it.</p>
<h2 id="lookahead">Lookahead<a class="headerlink" href="#lookahead" title="Permanent link">&para;</a></h2>
<p>The type of binary data can usually be identified by a specific header
coded in its first few bytes.
For example, <a href="https://en.wikipedia.org/wiki/WAV">WAVE</a> audio can be detected with the function:</p>
<pre><code>&gt;&gt;&gt; from bitstream import BitStream, ReadError

&gt;&gt;&gt; def is_wave(stream):
...    try:
...        riff = stream.read(bytes, 4)
...        _ = stream.read(bytes, 4)
...        wave = stream.read(bytes, 4)
...        return (riff == b"RIFF") and (wave == b"WAVE")
...    except ReadError:
...        return False
</code></pre>
<p>The contents of an empty single-channel 44.1 kHz WAVE audio file are for example</p>
<pre><code>&gt;&gt;&gt; wave = b'RIFF$\x00\x00\x00WAVEfmt \x10\x00\x00\x00\x01\x00\x01\x00D\xac\x00\x00\x88X\x01\x00\x02\x00\x10\x00data\x00\x00\x00\x00'
</code></pre>
<p>The function <code>is_wave</code> above works as expected at first</p>
<pre><code>&gt;&gt;&gt; stream = BitStream(wave)
&gt;&gt;&gt; is_wave(stream)
True
</code></pre>
<p>but another attempt gives an incorrect answer:</p>
<pre><code>&gt;&gt;&gt; is_wave(stream)
False
</code></pre>
<p>The explanation is simple: to identify the header of a WAVE file,
we need to consume the first 12 bytes in the stream. 
Since this header is missing from the stream afterwards, 
the new attempt fails.</p>
<p>To solve this issue, 
it's possible to make <code>is_wave</code> perform a (partial) copy of the stream 
and perform the check on the copy, leaving the initial 
stream unchanged. 
However in general this approach may be cumbersome;
copies should also be avoided when possible for performance reasons.</p>
<p>Bitstream also supports snapshots, 
a better way to deal with lookaheads.
With them you can:</p>
<ul>
<li>
<p>save the state of a stream at any time, </p>
</li>
<li>
<p>perform arbitrary operations on it and then </p>
</li>
<li>
<p>restore its initial state.</p>
</li>
</ul>
<p>The implementation of <code>is_wave</code> that does this is plain;
we just make sure that whatever happens 
(even an error in the processing) 
the original state of the stream is restored at the end. </p>
<pre><code>&gt;&gt;&gt; def is_wave(stream):
...     snapshot = stream.save()
...     try:
...         riff = stream.read(bytes, 4)
...         _ = stream.read(bytes, 4)
...         wave = stream.read(bytes, 4)
...         return (riff == b"RIFF") and (wave == b"WAVE")
...     except ReadError:
...         return False
...     finally:
...         stream.restore(snapshot)
</code></pre>
<p>This version works as expected:</p>
<pre><code>&gt;&gt;&gt; wave = b'RIFF$\x00\x00\x00WAVEfmt \x10\x00\x00\x00\x01\x00\x01\x00D\xac\x00\x00\x88X\x01\x00\x02\x00\x10\x00data\x00\x00\x00\x00'
&gt;&gt;&gt; stream = BitStream(wave)
&gt;&gt;&gt; copy = stream.copy()
&gt;&gt;&gt; is_wave(stream)
True
&gt;&gt;&gt; stream == copy
True
&gt;&gt;&gt; is_wave(stream)
True
</code></pre>
<h2 id="exception-safety">Exception Safety<a class="headerlink" href="#exception-safety" title="Permanent link">&para;</a></h2>
<p>Consider the toy DNA reader below:</p>
<pre><code>&gt;&gt;&gt; def DNA_read(stream, n=1):
...     DNA_bases = b"ACGT"
...     bases = []
...     for i in range(n):
...         base = stream.read(bytes, 1)
...         if base not in DNA_bases:
...             error = "invalid base {0!r}".format(base)
...             raise ReadError(error)
...         else:
...             bases.append(base)
...     return b"".join(bases)
</code></pre>
<p>It reads DNA sequences represented as bytes, either 
<code>b'A'</code>, <code>b'C'</code>, <code>b'G'</code> or <code>b'T'</code>:</p>
<pre><code>&gt;&gt;&gt; dna = BitStream(b"GATA")
&gt;&gt;&gt; DNA_read(dna, 4) # doctest: +BYTES
b'GATA'
</code></pre>
<p>If there is a <code>'U'</code> in the sequence, this is an error since
the <a href="https://en.wikipedia.org/wiki/Nucleobase">uracil base</a> 
is only found in RNA.</p>
<pre><code>&gt;&gt;&gt; stream = BitStream(b"GAUTA") # invalid DNA sequence
</code></pre>
<p>The DNA reader correctly rejects the code</p>
<pre><code>&gt;&gt;&gt; try:
...     DNA_read(stream, 4)
... except ReadError:
...     print("Read error")
Read error
</code></pre>
<p>but the initial stream is partially consumed in the process:</p>
<pre><code>&gt;&gt;&gt; stream.read(bytes) # doctest: +BYTES
b'TA'
</code></pre>
<p>This implementation therefore only provides some basic exception safety.
A reader that preserves the original value of the stream when an error
occurs would provide <a href="https://en.wikipedia.org/wiki/Exception_safety">strong exception safety</a> instead.
With snapshots, the modifications required to support this 
are plain: we simply restore the original stream whenever an
error occurs</p>
<pre><code>&gt;&gt;&gt; def DNA_read(stream, n=1):
...     DNA_bases = b"ACGT"
...     snapshot = stream.save()
...     try:
...         bases = []
...         for i in range(n):
...             base = stream.read(bytes, 1)
...             if base not in DNA_bases:
...                 error = "invalid base {0!r}".format(base)
...                 raise ReadError(error)
...             else:
...                 bases.append(base)
...         return "".join(bases)
...     except:
...         stream.restore(snapshot)
...         raise
</code></pre>
<p>With this new version, reading an invalid DNA code still 
raises an exception</p>
<pre><code>&gt;&gt;&gt; stream = BitStream(b"GAUTA") # invalid DNA sequence
&gt;&gt;&gt; try:
...     DNA_read(stream, 4)
... except ReadError:
...     print("Read error")
Read error
</code></pre>
<p>but now the original stream is intact</p>
<pre><code>&gt;&gt;&gt; stream.read(bytes) # doctest: +BYTES
b'GAUTA'
</code></pre>
<h2 id="multiple-snapshots">Multiple Snapshots<a class="headerlink" href="#multiple-snapshots" title="Permanent link">&para;</a></h2>
<p>You can create snapshots of a stream at any stage between read/write operations.
Multiple snapshots enable for example the implemention a hierarchy of readers 
or writers that provide strong exception safety at every level.</p>
<p>However arbitrary sequences of save and restore are not allowed:
when a given snapshot is restored, the snapshots that were created 
between the snapshot creation and before its restoration are forgotten.
In other words, saves and restores can only be applied in reverse order.
Of course it is perfectly valid to skip some of the restores in the process:
you can always create additional snapshots and never use them.</p>
<p>For example, you can take two snapshots <code>s0</code> then <code>s1</code> of a stream
between write operations</p>
<pre><code>&gt;&gt;&gt; stream = BitStream()
&gt;&gt;&gt; s0 = stream.save()
&gt;&gt;&gt; stream.write(b"A")
&gt;&gt;&gt; s1 = stream.save()
&gt;&gt;&gt; stream.write(b"B")
&gt;&gt;&gt; stream == BitStream(b"AB")
True
</code></pre>
<p>restore <code>s1</code></p>
<pre><code>&gt;&gt;&gt; stream.restore(s1)
&gt;&gt;&gt; stream == BitStream(b"A")
True
</code></pre>
<p>and then <code>s0</code></p>
<pre><code>&gt;&gt;&gt; stream.restore(s0)
&gt;&gt;&gt; stream == BitStream(b"")
True
</code></pre>
<p>You can also make the same snapshots </p>
<pre><code>&gt;&gt;&gt; stream = BitStream()
&gt;&gt;&gt; s0 = stream.save()
&gt;&gt;&gt; stream.write(b"A")
&gt;&gt;&gt; s1 = stream.save()
&gt;&gt;&gt; stream.write(b"B")
&gt;&gt;&gt; stream == BitStream(b"AB")
True
</code></pre>
<p>and directly restore <code>s0</code></p>
<pre><code>&gt;&gt;&gt; stream.restore(s0)
&gt;&gt;&gt; stream == BitStream(b"")
True
</code></pre>
<p>but then <code>s1</code> cannot be used anymore</p>
<pre><code>&gt;&gt;&gt; stream.restore(s1) # doctest: +ELLIPSIS
Traceback (most recent call last):
...
ValueError: ...
</code></pre>
<h2 id="how-does-it-work">How does it Work?<a class="headerlink" href="#how-does-it-work" title="Permanent link">&para;</a></h2>
<p>The main (private) attributes of a <code>BitStream</code> structure are:</p>
<ul>
<li>
<p>an array of bytes: the raw data</p>
</li>
<li>
<p>read and write cursors: they locate the beginning and the end 
    of the stream in the bytes array.</p>
</li>
</ul>
<p>When you read data from a stream, 
you shift the read cursor but the 
corresponding data is <em>not</em> deleted<sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup> -- its is merely not accessible.
The <code>State</code> structure stores values 
of the read and write cursors; the call <code>state = stream.save()</code> produces 
a snapshot of the current cursor locations and
<code>stream.restore(state)</code> restores them.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>This is why the memory consumption increases if you write a lot
of data into a stream, <em>even if you read it!</em> The solution in this case is to
copy the stream and discard the original since the copy method discards 
write history.&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div>
                
                  
                
              
              
                
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../custom/" title="Custom Types" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Custom Types
              </span>
            </div>
          </a>
        
        
          <a href="../API/" title="API Reference" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                API Reference
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="http://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.abd7b172.js"></script>
      
      <script>app.initialize({version:"0.17.2",url:{base:".."}})</script>
      
    
    
      
    
  </body>
</html>